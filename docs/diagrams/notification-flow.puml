@startuml notification-flow
!theme plain
title End-to-End Notification Delivery Flow

actor "User/System" as User
participant "HTTP API" as API
participant "Rate Limiter" as RateLimit
participant "Notification Handler" as Handler
participant "Notification Service" as Service
participant "Template Repository" as TemplateRepo
participant "Preferences Repository" as PrefRepo
participant "Channel Service\n(Email/SMS/Webhook)" as Channel
participant "Notification Repository" as NotifRepo
participant "Provider\n(SMTP/Twilio/etc)" as Provider
participant "Dead Letter Queue" as DLQ
participant "Metrics" as Metrics

User -> API: POST /api/v1/notifications/{type}
activate API

API -> RateLimit: Check rate limit
activate RateLimit
RateLimit --> API: OK
deactivate RateLimit

API -> Handler: Process request
activate Handler

Handler -> Service: Send notification
activate Service

Service -> PrefRepo: Check user preferences
activate PrefRepo
PrefRepo --> Service: User preferences
deactivate PrefRepo

alt Preferences allow notification
    Service -> TemplateRepo: Get template (if template_id provided)
    activate TemplateRepo
    TemplateRepo --> Service: Template
    deactivate TemplateRepo
    
    Service -> Service: Render template with variables
    
    Service -> NotifRepo: Create notification record
    activate NotifRepo
    NotifRepo --> Service: Notification ID
    deactivate NotifRepo
    
    Service -> Channel: Send via channel
    activate Channel
    
    Channel -> Provider: Send notification
    activate Provider
    
    alt Success
        Provider --> Channel: Success response
        deactivate Provider
        
        Channel -> NotifRepo: Update status: SENT
        activate NotifRepo
        NotifRepo --> Channel: Updated
        deactivate NotifRepo
        
        Channel -> Metrics: Record success
        activate Metrics
        Metrics --> Channel: Recorded
        deactivate Metrics
        
        Channel --> Service: Success
        deactivate Channel
        
    else Failure
        Provider --> Channel: Error response
        
        Channel -> NotifRepo: Update status: FAILED
        activate NotifRepo
        NotifRepo --> Channel: Updated
        deactivate NotifRepo
        
        Channel -> DLQ: Add to DLQ for retry
        activate DLQ
        DLQ --> Channel: Queued
        deactivate DLQ
        
        Channel -> Metrics: Record failure
        activate Metrics
        Metrics --> Channel: Recorded
        deactivate Metrics
        
        Channel --> Service: Failure
        deactivate Channel
    end
    
    Service --> Handler: Result
    deactivate Service
    
    Handler --> API: Response
    deactivate Handler
    
    API --> User: 200 OK / 500 Error
    deactivate API
    
else Preferences block notification
    Service --> Handler: Notification blocked
    deactivate Service
    Handler --> API: Blocked by preferences
    deactivate Handler
    API --> User: 200 OK (blocked)
    deactivate API
end

note right of DLQ
  Failed notifications are
  automatically retried with
  exponential backoff
end note

note right of Metrics
  All operations are
  tracked for monitoring
  and analytics
end note

@enduml
