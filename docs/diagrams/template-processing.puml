@startuml template-processing
!theme plain
title Template Processing Workflow

participant "Notification Service" as Service
participant "Template Repository" as TemplateRepo
participant "Template Cache" as Cache
participant "Template Engine" as Engine
participant "Validator" as Validator
database "MongoDB" as DB

Service -> TemplateRepo: GetTemplate(templateID)
activate TemplateRepo

TemplateRepo -> Cache: Check cache
activate Cache

alt Template in cache
    Cache --> TemplateRepo: Return cached template
    deactivate Cache
else Template not in cache
    Cache --> TemplateRepo: Not found
    deactivate Cache
    
    TemplateRepo -> DB: Query template by ID
    activate DB
    DB --> TemplateRepo: Template document
    deactivate DB
    
    TemplateRepo -> Cache: Store in cache
    activate Cache
    Cache --> TemplateRepo: Cached
    deactivate Cache
end

TemplateRepo --> Service: Template
deactivate TemplateRepo

Service -> Validator: Validate template variables
activate Validator

Validator -> Validator: Check required variables
Validator -> Validator: Validate variable types

alt Variables valid
    Validator --> Service: Validation passed
    deactivate Validator
    
    Service -> Engine: Render template
    activate Engine
    
    Engine -> Engine: Replace {{ variable }} placeholders
    Engine -> Engine: Execute conditional logic
    Engine -> Engine: Process loops
    Engine -> Engine: Apply filters
    
    alt Rendering successful
        Engine --> Service: Rendered content
        deactivate Engine
        
        Service -> Service: Apply content sanitization
        Service -> Service: Generate final message
        
    else Rendering failed
        Engine --> Service: Rendering error
        deactivate Engine
        Service -> Service: Use fallback content
    end
    
else Variables invalid
    Validator --> Service: Validation failed
    deactivate Validator
    Service -> Service: Use default template or error
end

note right of Cache
  Template cache:
  - TTL: 1 hour
  - LRU eviction
  - Per-tenant isolation
end note

note right of Engine
  Supported features:
  - Variable substitution
  - Conditional blocks
  - Loops/iterations
  - Filters (upper, lower, etc)
  - HTML/text escaping
end note

note right of Validator
  Validates:
  - Required variables present
  - Variable types match
  - No XSS/injection risks
  - Content length limits
end note

@enduml
